<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>SARAH has wet hair</title>
  <script type="text/javascript" src="/assets/phaser.min.js"></script>
  <link rel="stylesheet" type="text/css" href="assets/styles.css">
</head>

<body>
  <!-- This is you -> :)
  This is your baby brother -> >:)
  This is the zombie apocalypse -> :s :( D:

  endless runner style
  2 button input
  touch left for baby attack
  touch right for jump

  zombies come from left
  obstacles come from right  -->
  <script type="text/javascript">
    var game = new Phaser.Game(800, 600, Phaser.AUTO, '', {
      preload: preload,
      create: create,
      update: update,
      render: render
    });

    function render() {
      game.debug.cameraInfo(game.camera, 32, 32);
      game.debug.spriteCoords(player, 32, 500);
    }
    function preload() {
      game.load.spritesheet('button', 'assets/button_sprite_sheet.png', 193, 71);
      game.load.image('sky', 'assets/sky.png');
      game.load.image('ground', 'assets/platform.png');
      game.load.image('star', 'assets/star.png');
      game.load.image('tree', 'assets/tree.png');
      game.load.image('cloud', 'assets/cloud.png');
      game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
      game.load.spritesheet('baddie', 'assets/baddie.png', 32, 32);
    }
    var scoreText, button, platforms, player, cursors, stars, baddies, lasers, trees;
    var mouseTouchDown = false;
    var baddiesKilled = 0;
    var score = 0;

    function resetLaser(laser) {
      laser.kill();
    }

    function create() {
      game.physics.startSystem(Phaser.Physics.ARCADE);
      game.world.setBounds(0, 0, 2800, 600);
      game.add.tileSprite(0, 0, 2800, 600, 'sky');

      lasers = game.add.group();
      lasers.enableBody = true;
      lasers.physicsBodyType = Phaser.Physics.ARCADE;
      lasers.createMultiple(20, 'star');
      lasers.callAll('events.onOutOfBounds.add', 'events.onOutOfBounds', resetLaser);
      lasers.callAll('anchor.setTo', 'anchor', 0.5, 1.0);
      lasers.setAll('checkWorldBounds', true);

      platforms = game.add.group();
      platforms.enableBody = true;
      platforms.physicsBodyType = Phaser.Physics.ARCADE;
      platforms.createMultiple(5, 'ground');
      for (var i = 0; i < platforms.length; i++) {
        var ground = platforms.getChildAt(i);
        ground.events.onOutOfBounds.add(spawnFloor, this);
        ground.checkWorldBounds = true;
      }
      spawnFloor(null);

      player = game.add.sprite(400, 600 - 130, 'dude');

      game.physics.arcade.enable(player);

      player.body.bounce.y = 0.2;
      player.body.gravity.y = 1000;
      player.body.mass = 0.1;
      player.body.collideWorldBounds = true;

      player.animations.add('left', [0, 1, 2, 3], 10, true);
      player.animations.add('right', [5, 6, 7, 8], 10, true);
      player.anchor.setTo(0.5, 0.5);
      game.camera.follow(player, Phaser.Camera.FOLLOW_LOCKON);
      cursors = game.input.keyboard.createCursorKeys();
      stars = game.add.group();

      stars.enableBody = true;

      //  Here we'll create 12 of them evenly spaced apart
      for (var i = 0; i < 12; i++) {
        //  Create a star inside of the 'stars' group
        var star = stars.create(i * 70, 0, 'star');

        //  Let gravity do its thing
        star.body.gravity.y = 900;

        //  This just gives each star a slightly random bounce value
        star.body.bounce.y = 0.7 + Math.random() * 0.2;
      }
      scoreText = game.add.text(16, 16, 'score: 0', {
        fontSize: '32px',
        fill: '#000'
      });


      baddies = game.add.group();
      baddies.enableBody = true;
      baddies.physicsBodyType = Phaser.Physics.ARCADE;
      baddies.createMultiple(20, 'baddie');
      baddies.callAll('events.onOutOfBounds.add', 'events.onOutOfBounds', spawnBaddie);
      baddies.callAll('events.onKilled.add', 'events.onKilled', spawnBaddie);
      baddies.callAll('anchor.setTo', 'anchor', 0.5, 1.0);
      baddies.setAll('checkWorldBounds', true);
      game.physics.arcade.enable(baddies);

      for (var i = 0; i < baddies.length; i++) {
        //  Let gravity do its thing
        var baddie = baddies.getChildAt(i);
        baddie.body.bounce.y = 0.2;
        baddie.body.gravity.y = 300;
        baddie.body.collideWorldBounds = true;

        // //  Our two animations, walking left and right.
        baddie.animations.add('left', [0, 1], 10, true);
        baddie.animations.add('right', [2, 3], 10, true);
      }

      trees = game.add.group();
      trees.enableBody = true;
      trees.physicsBodyType = Phaser.Physics.ARCADE;
      trees.createMultiple(20, 'tree');
      trees.callAll('events.onOutOfBounds.add', 'events.onOutOfBounds', spawnTree);
      trees.callAll('events.onKilled.add', 'events.onKilled', spawnTree);
      trees.callAll('anchor.setTo', 'anchor', 0.5, 0.5);
      trees.setAll('checkWorldBounds', true);
      game.physics.arcade.enable(trees);

      for (var i = 0; i < trees.length; i++) {
        //  Let gravity do its thing
        var tree = trees.getChildAt(i);
        tree.body.bounce.y = 0.2;
        // tree.body.gravity.y = 300;
        tree.body.collideWorldBounds = false;
        tree.body.immovable = true;
      }

      button = game.add.button(game.camera.x + (game.width * 0.5), game.camera.y + (game.height * 0.5), 'button', actionOnClick, this, 2, 1, 0);
      button.anchor.setTo(0.5, 0.5);
      button.fixedToCamera = true;
      button.visible = false;

      spawnBaddie();
      spawnTree();
    }
    function actionOnClick () {
      game.state.restart(true, true);
      button.visible = false;
    }
    function collectStar(player, star) {
      // Removes the star from the screen
      star.kill();

      //  Add and update the score
      score += 10;
      scoreText.text = 'Score: ' + score;
    }

    function killBaddie(baddie, laser) {
      // Removes the star from the screen
      baddie.kill();
      laser.kill();
      //  Add and update the score
      score += 10;
      scoreText.text = 'Score: ' + score;
      baddiesKilled += 1;
    }

    function update() {
      //  Collide the player and the stars with the platforms
      var hitPlatform = game.physics.arcade.collide(player, platforms);
      var baddieHitPlatform = game.physics.arcade.collide(baddies, platforms);
      var hitBaddie = game.physics.arcade.collide(player, baddies);
      game.physics.arcade.collide(stars, platforms);
      game.physics.arcade.collide(trees, platforms);
      game.physics.arcade.collide(player, trees);
      game.physics.arcade.overlap(player, stars, collectStar, null, this);
      game.physics.arcade.overlap(baddies, lasers, killBaddie, null, this);
      //  Reset the players velocity (movement)
      player.body.velocity.x = 100;
      if (hitBaddie) {
        player.kill();
      }
      player.animations.play('right');


      //  Allow the player to jump if they are touching the ground.
      if (cursors.up.isDown && player.body.touching.down && hitPlatform) {
        player.body.velocity.y = -550;
      }

      baddies.setAll('body.velocity.x', 100);

      for (var i = 0; i < baddies.length; i++) {
        var baddie = baddies.getChildAt(i);
        if (player.x < baddie.x && player.alive) {
          //  Move to the left
          baddie.body.velocity.x -= 50;

          baddie.animations.play('left');
        } else if (player.x > baddie.x && player.alive) {
          //  Move to the right
          baddie.body.velocity.x += 50;

          baddie.animations.play('right');
        } else {
          //  Stand still
          baddie.animations.stop();
          baddie.frame = 2;
        }

        //  Allow the baddie to jump if they are touching the ground.
        if (player.body.bottom < baddie.body.bottom && baddie.body.touching.down && baddieHitPlatform && player.alive) {
          baddie.body.velocity.y = -350;
        }
      }
      // Game.input.activePointer is either the first finger touched, or the mouse
      if (game.input.activePointer.isDown) {
        // We'll manually keep track if the pointer wasn't already down
        if (!mouseTouchDown) {
          touchDown();
        }
      } else {
        if (mouseTouchDown) {
          touchUp();
        }
      }

      if (!player.alive) {
        button.visible = true;
      }
    }
    function touchDown() {
      // Set touchDown to true, so we only trigger this once
      mouseTouchDown = true;
      fireLaser();
    }

    function touchUp() {
      // Set touchDown to false, so we can trigger touchDown on the next click
      mouseTouchDown = false;
    }

    function fireLaser() {
      // Get the first laser that's inactive, by passing 'false' as a parameter
      var laser = lasers.getFirstExists(false);
      if (laser) {
        // If we have a laser, set it to the starting position
        laser.reset(player.body.center.x, player.body.center.y+10);
        // Give it a velocity of -500 so it starts shooting
        laser.body.velocity.x = -500;
      }
    }
    function spawnBaddie() {
      for (var i = -1; i < baddiesKilled; i++) {
        setTimeout(function(){
          var baddie = baddies.getFirstExists(false);
          if (baddie) {
            // If we have a baddie, set it to the starting position
            baddie.reset(32, game.world.height - 150);
            baddie.body.velocity.x = 0;
          }
        }, 500 + (500 * i));
      }
    }
    function spawnTree() {
      var tree = trees.getFirstExists(false);
      if (tree) {
        // If we have a tree, set it to the starting position
        tree.reset(game.camera.x + (game.width * 1.1), game.camera.y + (game.height - 100));
        // Give it a velocity of -500 so it starts shooting
      }
    }
    function spawnFloor(x) {
      debugger;
      var ground = platforms.getFirstExists(false);
      if (ground) {
        var lastGround = lastAliveGround();
        do {
          debugger;
          ground.reset(lastGround == null ? 0 : lastGround.body.right/*(game.camera.x + (game.width))*/, game.camera.y + (game.height - 64));

          ground.body.immovable = true;
          ground.events.onOutOfBounds.add(spawnFloor, this);
          ground.checkWorldBounds = true;
          ground = platforms.getFirstExists(false);
          if (!ground) {
            break;
          }
          lastGround = lastAliveGround();
        } while (Phaser.Rectangle.intersects(lastGround.getLocalBounds(), game.camera.view));
      }
    }
    function lastAliveGround() {
      debugger;
      var last = {x: -100};
      var found = false;
      for (var i = 0; i < platforms.length; i++) {
        var platform = platforms.getChildAt(i);
        if (platform.alive && platform.x > last.x) {
          last = platform;
          found = true;
        }
      }
      return found ? last : null;
    }
  </script>
</body>
</html>
