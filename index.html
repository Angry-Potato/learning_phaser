<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>SARAH has wet hair</title>
    <script type="text/javascript" src="/assets/phaser.min.js"></script>
    <link rel="stylesheet" type="text/css" href="assets/styles.css">
</head>

<body>

    <script type="text/javascript">
        var game = new Phaser.Game(800, 600, Phaser.AUTO, '', {
            preload: preload,
            create: create,
            update: update
        });

        function preload() {
            game.load.image('sky', 'assets/sky.png');
            game.load.image('ground', 'assets/platform.png');
            game.load.image('star', 'assets/star.png');
            game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
            game.load.spritesheet('baddie', 'assets/baddie.png', 32, 32);
        }
        var platforms, player, cursors, stars, baddie, lasers;
        var mouseTouchDown = false;
        var score = 0;
        var scoreText;

        function resetLaser(laser) {
          // Destroy the laser
          laser.kill();
        }

        function create() {
            //  We're going to be using physics, so enable the Arcade Physics system
            game.physics.startSystem(Phaser.Physics.ARCADE);

            //  A simple background for our game
            game.add.sprite(0, 0, 'sky');

            lasers = game.add.group();
            lasers.enableBody = true;
            lasers.physicsBodyType = Phaser.Physics.ARCADE;
            lasers.createMultiple(20, 'star');
            lasers.callAll('events.onOutOfBounds.add', 'events.onOutOfBounds', resetLaser);
            lasers.callAll('anchor.setTo', 'anchor', 0.5, 1.0);
            lasers.setAll('checkWorldBounds', true);

            //  The platforms group contains the ground and the 2 ledges we can jump on
            platforms = game.add.group();

            //  We will enable physics for any object that is created in this group
            platforms.enableBody = true;

            // Here we create the ground.
            var ground = platforms.create(0, game.world.height - 64, 'ground');

            //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
            ground.scale.setTo(2, 2);

            //  This stops it from falling away when you jump on it
            ground.body.immovable = true;

            //  Now let's create two ledges
            var ledge = platforms.create(400, 400, 'ground');

            ledge.body.immovable = true;

            ledge = platforms.create(-150, 250, 'ground');

            ledge.body.immovable = true;
            // The player and its settings
            player = game.add.sprite(32, game.world.height - 150, 'dude');

            //  We need to enable physics on the player
            game.physics.arcade.enable(player);

            //  Player physics properties. Give the little guy a slight bounce.
            player.body.bounce.y = 0.2;
            player.body.gravity.y = 1000;
            player.body.collideWorldBounds = true;

            //  Our two animations, walking left and right.
            player.animations.add('left', [0, 1, 2, 3], 10, true);
            player.animations.add('right', [5, 6, 7, 8], 10, true);
            cursors = game.input.keyboard.createCursorKeys();
            stars = game.add.group();

            stars.enableBody = true;

            //  Here we'll create 12 of them evenly spaced apart
            for (var i = 0; i < 12; i++) {
                //  Create a star inside of the 'stars' group
                var star = stars.create(i * 70, 0, 'star');

                //  Let gravity do its thing
                star.body.gravity.y = 900;

                //  This just gives each star a slightly random bounce value
                star.body.bounce.y = 0.7 + Math.random() * 0.2;
            }
            scoreText = game.add.text(16, 16, 'score: 0', {
                fontSize: '32px',
                fill: '#000'
            });


            // The baddie and its settings
            baddie = game.add.sprite(32, game.world.height - 200, 'baddie');

            //  We need to enable physics on the baddie
            game.physics.arcade.enable(baddie);

            //  Baddie physics properties. Give the little guy a slight bounce.
            baddie.body.bounce.y = 0.2;
            baddie.body.gravity.y = 300;
            baddie.body.collideWorldBounds = true;

            //  Our two animations, walking left and right.
            baddie.animations.add('left', [0, 1], 10, true);
            baddie.animations.add('right', [2, 3], 10, true);
        }

        function collectStar(player, star) {

            // Removes the star from the screen
            star.kill();

            //  Add and update the score
            score += 10;
            scoreText.text = 'Score: ' + score;
        }

        function killBaddie(baddie, laser) {

            // Removes the star from the screen
            baddie.kill();
            laser.kill();
            //  Add and update the score
            score += 10;
            scoreText.text = 'Score: ' + score;
        }

        function update() {
            //  Collide the player and the stars with the platforms
            var hitPlatform = game.physics.arcade.collide(player, platforms);
            var baddieHitPlatform = game.physics.arcade.collide(baddie, platforms);
            var hitBaddie = game.physics.arcade.collide(player, baddie);
            game.physics.arcade.collide(stars, platforms);
            game.physics.arcade.overlap(player, stars, collectStar, null, this);
            game.physics.arcade.overlap(baddie, lasers, killBaddie, null, this);
            //  Reset the players velocity (movement)
            player.body.velocity.x = 0;
            if (hitBaddie) {
              player.kill();
            }
            if (cursors.left.isDown) {
                //  Move to the left
                player.body.velocity.x = -150;

                player.animations.play('left');
            } else if (cursors.right.isDown) {
                //  Move to the right
                player.body.velocity.x = 150;

                player.animations.play('right');
            } else {
                //  Stand still
                player.animations.stop();

                player.frame = 4;
            }

            //  Allow the player to jump if they are touching the ground.
            if (cursors.up.isDown && player.body.touching.down && hitPlatform) {
                player.body.velocity.y = -550;
            }

            baddie.body.velocity.x = 0;

            if (player.x < baddie.x && player.alive) {
                //  Move to the left
                baddie.body.velocity.x = -50;

                baddie.animations.play('left');
            } else if (player.x > baddie.x && player.alive) {
                //  Move to the right
                baddie.body.velocity.x = 50;

                baddie.animations.play('right');
            } else {
                //  Stand still
                baddie.animations.stop();

                baddie.frame = 2;
            }

            //  Allow the baddie to jump if they are touching the ground.
            if (player.body.bottom < baddie.body.bottom && baddie.body.touching.down && baddieHitPlatform && player.alive) {
                baddie.body.velocity.y = -350;
            }

            // Game.input.activePointer is either the first finger touched, or the mouse
            if (game.input.activePointer.isDown) {
              // We'll manually keep track if the pointer wasn't already down
              if (!mouseTouchDown) {
                touchDown();
              }
            } else {
              if (mouseTouchDown) {
                touchUp();
              }
            }

            if (!player.alive) {
              game.state.restart(true, true);
            }
        }
        function touchDown() {
        	// Set touchDown to true, so we only trigger this once
        	mouseTouchDown = true;
        	fireLaser();
        }

        function touchUp() {
        	// Set touchDown to false, so we can trigger touchDown on the next click
        	mouseTouchDown = false;
        }

        function fireLaser() {
        	// Get the first laser that's inactive, by passing 'false' as a parameter
        	var laser = lasers.getFirstExists(false);
        	if (laser) {
        		// If we have a laser, set it to the starting position
        		laser.reset(player.x, player.y - 20);
        		// Give it a velocity of -500 so it starts shooting
        		laser.body.velocity.y = -500;
        	}

        }
    </script>

</body>

</html>
